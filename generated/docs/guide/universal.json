{
  "id": "guide/universal",
  "title": "Angular Universal: server-side rendering",
  "contents": "\n<div class=\"content\">\n<h1 translation-origin=\"off\" id=\"angular-universal-server-side-rendering\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#angular-universal-server-side-rendering\"><i class=\"material-icons\">link</i></a>Angular Universal: server-side rendering</h1>\n<p translation-origin=\"off\">This guide describes <strong>Angular Universal</strong>, a technology that runs your Angular application on the server.</p>\n<p translation-origin=\"off\">A normal Angular application executes in the <em>browser</em>, rendering pages in the DOM in response to user actions.</p>\n<p translation-origin=\"off\"><strong>Angular Universal</strong> generates <em>static</em> application pages on the <em>server</em>\nthrough a process called <strong>server-side rendering (SSR)</strong>.</p>\n<p translation-origin=\"off\">It can generate and serve those pages in response to requests from browsers.\nIt can also pre-generate pages as HTML files that you serve later.</p>\n<p translation-origin=\"off\">This guide describes a Universal sample application that launches quickly as a server-rendered page.\nMeanwhile, the browser downloads the full client version and switches to it automatically after the code loads.</p>\n<div class=\"l-sub-section\">\n<p translation-origin=\"off\"><a href=\"generated/zips/universal/universal.zip\">Download the finished sample code</a>,\nwhich runs in a <a href=\"https://expressjs.com/\">node express</a> server.</p>\n</div>\n<a id=\"why-do-it\"></a>\n<h3 translation-origin=\"off\" id=\"why-universal\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#why-universal\"><i class=\"material-icons\">link</i></a>Why Universal</h3>\n<p translation-origin=\"off\">There are three main reasons to create a Universal version of your app.</p>\n<ol>\n<li>\n<p translation-origin=\"off\">Facilitate web crawlers (SEO)</p>\n</li>\n<li>\n<p translation-origin=\"off\">Improve performance on mobile and low-powered devices</p>\n</li>\n<li>\n<p translation-origin=\"off\">Show the first page quickly</p>\n</li>\n</ol>\n<a id=\"seo\"></a>\n<a id=\"web-crawlers\"></a>\n<h4 translation-origin=\"off\" id=\"facilitate-web-crawlers\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#facilitate-web-crawlers\"><i class=\"material-icons\">link</i></a>Facilitate web crawlers</h4>\n<p translation-origin=\"off\">Google, Bing, Facebook, Twitter and other social media sites rely on web crawlers to index your application content and make that content searchable on the web.</p>\n<p translation-origin=\"off\">These web crawlers may be unable to navigate and index your highly-interactive, Angular application as a human user could do.</p>\n<p translation-origin=\"off\">Angular Universal can generate a static version of your app that is easily searchable, linkable, and navigable without JavaScript.\nIt also makes a site preview available since each URL returns a fully-rendered page.</p>\n<p translation-origin=\"off\">Enabling web crawlers is often referred to as\n<a href=\"https://static.googleusercontent.com/media/www.google.com/en//webmasters/docs/search-engine-optimization-starter-guide.pdf\">Search Engine Optimization (SEO)</a>.</p>\n<a id=\"no-javascript\"></a>\n<h4 translation-origin=\"off\" id=\"performance-on-mobile-and-low-performance-devices\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#performance-on-mobile-and-low-performance-devices\"><i class=\"material-icons\">link</i></a>Performance on mobile and low performance devices</h4>\n<p translation-origin=\"off\">Some devices don't support JavaScript or execute JavaScript so poorly that the user experience is unacceptable.\nFor these cases, you may require a server-rendered, no-JavaScript version of the app.\nThis version, however limited, may be the only practical alternative for\npeople who otherwise would not be able to use the app at all.</p>\n<a id=\"startup-performance\"></a>\n<h4 translation-origin=\"off\" id=\"show-the-first-page-quickly\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#show-the-first-page-quickly\"><i class=\"material-icons\">link</i></a>Show the first page quickly</h4>\n<p translation-origin=\"off\">Displaying the first page quickly can be critical for user engagement.</p>\n<p translation-origin=\"off\"><a href=\"https://www.doubleclickbygoogle.com/articles/mobile-speed-matters/\">53% of mobile site visits are abandoned</a> if pages take longer than 3 seconds to load.\nYour app may have to launch faster to engage these users before they decide to do something else.</p>\n<p translation-origin=\"off\">With Angular Universal, you can generate landing pages for the app that look like the complete app.\nThe pages are pure HTML, and can display even if JavaScript is disabled.\nThe pages do not handle browser events, but they <em>do</em> support navigation through the site using <a href=\"guide/router.html#router-link\">routerLink</a>.</p>\n<p translation-origin=\"off\">In practice, you'll serve a static version of the landing page to hold the user's attention.\nAt the same time, you'll load the full Angular app behind it in the manner <a href=\"guide/universal#transition\">explained below</a>.\nThe user perceives near-instant performance from the landing page\nand gets the full interactive experience after the full app loads.</p>\n<a id=\"how-does-it-work\"></a>\n<h3 translation-origin=\"off\" id=\"how-it-works\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#how-it-works\"><i class=\"material-icons\">link</i></a>How it works</h3>\n<p translation-origin=\"off\">To make a Universal app, you install the <code>platform-server</code> package.\nThe <code>platform-server</code> package has server implementations of the DOM, <code>XMLHttpRequest</code>, and other low-level features that do not rely on a browser.</p>\n<p translation-origin=\"off\">You compile the client application with the <code>platform-server</code> module instead of the <code>platform-browser</code> module.\nand run the resulting Universal app on a web server.</p>\n<p translation-origin=\"off\">The server (a <a href=\"https://expressjs.com/\">Node Express</a> server in <em>this</em> guide's example)\npasses client requests for application pages to Universal's <code><a href=\"api/platform-server/renderModuleFactory\" class=\"code-anchor\">renderModuleFactory</a></code> function.</p>\n<p translation-origin=\"off\">The <code><a href=\"api/platform-server/renderModuleFactory\" class=\"code-anchor\">renderModuleFactory</a></code> function takes as inputs a <em>template</em> HTML page (usually <code>index.html</code>),\nan Angular <em>module</em> containing components,\nand a <em>route</em> that determines which components to display.</p>\n<p translation-origin=\"off\">The route comes from the client's request to the server.\nEach request results in the appropriate view for the requested route.</p>\n<p translation-origin=\"off\">The <code><a href=\"api/platform-server/renderModuleFactory\" class=\"code-anchor\">renderModuleFactory</a></code> renders that view within the <code>&#x3C;app></code> tag of the template, creating a finished HTML page for the client.</p>\n<p translation-origin=\"off\">Finally, the server returns the rendered page to the client.</p>\n<h3 translation-origin=\"off\" id=\"working-around-the-browser-apis\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#working-around-the-browser-apis\"><i class=\"material-icons\">link</i></a>Working around the browser APIs</h3>\n<p translation-origin=\"off\">Because a Universal <code>platform-server</code> app doesn't execute in the browser, you may have to work around some of the browser APIs and capabilities that are missing on the server.</p>\n<p translation-origin=\"off\">You won't be able reference browser-only native objects such as <code>window</code>, <code>document</code>, <code>navigator</code> or <code>location</code>.\nIf you don't need them on the server-rendered page, side-step them with conditional logic.</p>\n<p translation-origin=\"off\">Alternatively, look for an injectable Angular abstraction over the object you need such as <code><a href=\"api/common/Location\" class=\"code-anchor\">Location</a></code> or <code>Document</code>;\nit may substitute adequately for the specific API that you're calling.\nIf Angular doesn't provide it, you may be able to write your own abstraction that delegates to the browser API while in the browser and to a satisfactory alternative implementation while on the server.</p>\n<p translation-origin=\"off\">Without mouse or keyboard events, a universal app can't rely on a user clicking a button to show a component.\nA universal app should determine what to render based solely on the incoming client request.\nThis is a good argument for making the app <a href=\"guide/router\">routeable</a>.</p>\n<p translation-origin=\"off\">Because the user of a server-rendered page can't do much more than click links,\nyou should <a href=\"guide/universal#transition\">swap in the real client app</a> as quickly as possible for a proper interactive experience.</p>\n<a id=\"the-example\"></a>\n<h2 translation-origin=\"off\" id=\"the-example\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#the-example\"><i class=\"material-icons\">link</i></a>The example</h2>\n<p translation-origin=\"off\">The <em>Tour of Heroes</em> tutorial is the foundation for the Universal sample described in this guide.</p>\n<p translation-origin=\"off\">The core application files are mostly untouched, with a few exceptions described below.\nYou'll add more files to support building and serving with Universal.</p>\n<p translation-origin=\"off\">In this example, the Angular CLI compiles and bundles the Universal version of the app with the\n<a href=\"guide/aot-compiler\">AOT (Ahead-of-Time) compiler</a>.\nA node/express web server turns client requests into the HTML pages rendered by Universal.</p>\n<p translation-origin=\"off\">You will create:</p>\n<ul>\n<li>\n<p translation-origin=\"off\">a server-side app module, <code>app.server.module.ts</code></p>\n</li>\n<li>\n<p translation-origin=\"off\">an entry point for the server-side, <code>main.server.ts</code></p>\n</li>\n<li>\n<p translation-origin=\"off\">an express web server to handle requests, <code>server.ts</code></p>\n</li>\n<li>\n<p translation-origin=\"off\">a TypeScript config file, <code>tsconfig.server.json</code></p>\n</li>\n<li>\n<p translation-origin=\"off\">a Webpack config file for the server, <code>webpack.server.config.js</code></p>\n</li>\n</ul>\n<p translation-origin=\"off\">When you're done, the folder structure will look like this:</p>\n<code-example format=\".\" language=\"none\" linenums=\"false\">\n\nsrc/\n  index.html                 <i>app web page</i>\n  main.ts                    <i>bootstrapper for client app</i>\n  main.server.ts             <i>* bootstrapper for server app</i>\n  tsconfig.app.json          <i>TypeScript client configuration</i>\n  tsconfig.server.json       <i>* TypeScript server configuration</i>\n  tsconfig.spec.json         <i>TypeScript spec configuration</i>\n  style.css                  <i>styles for the app</i>\n  app/ ...                   <i>application code</i>\n    app.server.module.ts     <i>* server-side application module</i>\nserver.ts                    <i>* express web server</i>\ntsconfig.json                <i>TypeScript client configuration</i>\npackage.json                 <i>npm configuration</i>\nwebpack.server.config.js     <i>* Webpack server configuration</i>\n\n</code-example>\n<p translation-origin=\"off\">The files marked with <code>*</code> are new and not in the original tutorial sample.\nThis guide covers them in the sections below.</p>\n<a id=\"preparation\"></a>\n<h2 translation-origin=\"off\" id=\"preparation\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#preparation\"><i class=\"material-icons\">link</i></a>Preparation</h2>\n<h2 translation-result=\"\" id=\"preparation\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#preparation\"><i class=\"material-icons\">link</i></a>准备工作</h2>\n<p translation-origin=\"off\">Download the <a href=\"generated/zips/toh-pt6/toh-pt6.zip\">Tour of Heroes</a> project and install the dependencies from it.</p>\n<a id=\"install-the-tools\"></a>\n<h3 translation-origin=\"off\" id=\"install-the-tools\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#install-the-tools\"><i class=\"material-icons\">link</i></a>Install the tools</h3>\n<p translation-origin=\"off\">To get started, install these packages.</p>\n<ul>\n<li>\n<p translation-origin=\"off\"><code>@angular/platform-server</code> - Universal server-side components.</p>\n</li>\n<li>\n<p translation-origin=\"off\"><code>@nguniversal/module-map-ngfactory-loader</code> - For handling lazy-loading in the context of a server-render.</p>\n</li>\n<li>\n<p translation-origin=\"off\"><code>@nguniversal/express-engine</code> - An express engine for Universal applications.</p>\n</li>\n<li>\n<p translation-origin=\"off\"><code>ts-loader</code> - To transpile the server application</p>\n</li>\n</ul>\n<p translation-origin=\"off\">Install them with the following commands:</p>\n<code-example format=\".\" language=\"bash\">\n\nnpm install --save @angular/platform-server @nguniversal/module-map-ngfactory-loader ts-loader @nguniversal/express-engine\n\n</code-example>\n<a id=\"transition\"></a>\n<h3 translation-origin=\"off\" id=\"modify-the-client-app\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#modify-the-client-app\"><i class=\"material-icons\">link</i></a>Modify the client app</h3>\n<p translation-origin=\"off\">A Universal app can act as a dynamic, content-rich \"splash screen\" that engages the user.\nIt gives the appearance of a near-instant application.</p>\n<p translation-origin=\"off\">Meanwhile, the browser downloads the client app scripts in background.\nOnce loaded, Angular transitions from the static server-rendered page to the dynamically rendered views of the interactive client app.</p>\n<p translation-origin=\"off\">You must make a few changes to your application code to support both server-side rendering and the transition to the client app.</p>\n<h4 translation-origin=\"off\" id=\"the-root-appmodule\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#the-root-appmodule\"><i class=\"material-icons\">link</i></a>The root <code>AppModule</code></h4>\n<p translation-origin=\"off\">Open file <code>src/app/app.module.ts</code> and find the <code><a href=\"api/platform-browser/BrowserModule\" class=\"code-anchor\">BrowserModule</a></code> import in the <code><a href=\"api/core/NgModule\" class=\"code-anchor\">NgModule</a></code> metadata.\nReplace that import with this one:</p>\n<code-example path=\"universal/src/app/app.module.ts\" region=\"browsermodule\" title=\"src/app/app.module.ts (withServerTransition)\">\n<a href=\"api/platform-browser/BrowserModule\" class=\"code-anchor\">BrowserModule</a>.withServerTransition({ appId: 'tour-of-heroes' }),\n\n</code-example>\n<p translation-origin=\"off\">Angular adds the <code>appId</code> value (which can be <em>any</em> string) to the style-names of the server-rendered pages,\nso that they can be identified and removed when the client app starts.</p>\n<p translation-origin=\"off\">You can get runtime information about the current platform and the <code>appId</code> by injection.</p>\n<code-example path=\"universal/src/app/app.module.ts\" region=\"platform-detection\" title=\"src/app/app.module.ts (platform detection)\">\nimport { <a href=\"api/core/PLATFORM_ID\" class=\"code-anchor\">PLATFORM_ID</a>, <a href=\"api/core/APP_ID\" class=\"code-anchor\">APP_ID</a>, <a href=\"api/core/Inject\" class=\"code-anchor\">Inject</a> } from '@angular/core';\nimport { <a href=\"api/common/isPlatformBrowser\" class=\"code-anchor\">isPlatformBrowser</a> } from '@angular/common';\n\n  constructor(\n    @<a href=\"api/core/Inject\" class=\"code-anchor\">Inject</a>(<a href=\"api/core/PLATFORM_ID\" class=\"code-anchor\">PLATFORM_ID</a>) private platformId: Object,\n    @<a href=\"api/core/Inject\" class=\"code-anchor\">Inject</a>(<a href=\"api/core/APP_ID\" class=\"code-anchor\">APP_ID</a>) private appId: string) {\n    const platform = <a href=\"api/common/isPlatformBrowser\" class=\"code-anchor\">isPlatformBrowser</a>(platformId) ?\n      'in the <a href=\"api/animations/browser\" class=\"code-anchor\">browser</a>' : 'on the server';\n    console.log(`Running ${platform} with appId=${appId}`);\n  }\n\n</code-example>\n<a id=\"http-urls\"></a>\n<h4 translation-origin=\"off\" id=\"absolute-http-urls\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#absolute-http-urls\"><i class=\"material-icons\">link</i></a>Absolute HTTP URLs</h4>\n<p translation-origin=\"off\">The tutorial's <code>HeroService</code> and <code>HeroSearchService</code> delegate to the Angular <code><a href=\"api/http/Http\" class=\"code-anchor\">Http</a></code> module to fetch application data.\nThese services send requests to <em>relative</em> URLs such as <code>api/heroes</code>.</p>\n<p translation-origin=\"off\">In a Universal app, <code><a href=\"api/http/Http\" class=\"code-anchor\">Http</a></code> URLs must be <em>absolute</em> (e.g., <code>https://my-server.com/api/heroes</code>)\neven when the Universal web server is capable of handling those requests.</p>\n<p translation-origin=\"off\">You'll have to change the services to make requests with absolute URLs when running on the server\nand with relative URLs when running in the browser.</p>\n<p translation-origin=\"off\">One solution is to provide the server's runtime origin under the Angular <a href=\"api/common/APP_BASE_HREF\"><code>APP_BASE_REF</code> token</a>,\ninject it into the service, and prepend the origin to the request URL.</p>\n<p translation-origin=\"off\">Start by changing the <code>HeroService</code> constructor to take a second <code>origin</code> parameter that is optionally injected via the <code><a href=\"api/common/APP_BASE_HREF\" class=\"code-anchor\">APP_BASE_HREF</a></code> token.</p>\n<code-example path=\"universal/src/app/hero.service.ts\" region=\"ctor\" title=\"src/app/hero.service.ts (constructor with optional origin)\">\nconstructor(\n  private http: <a href=\"api/common/http/HttpClient\" class=\"code-anchor\">HttpClient</a>,\n  private messageService: MessageService,\n  @<a href=\"api/core/Optional\" class=\"code-anchor\">Optional</a>() @<a href=\"api/core/Inject\" class=\"code-anchor\">Inject</a>(<a href=\"api/common/APP_BASE_HREF\" class=\"code-anchor\">APP_BASE_HREF</a>) origin: string) {\n    this.heroesUrl = `${origin}${this.heroesUrl}`;\n  }\n\n</code-example>\n<p translation-origin=\"off\">Note how the constructor prepends the origin (if it exists) to the <code>heroesUrl</code>.</p>\n<p translation-origin=\"off\">You don't provide <code><a href=\"api/common/APP_BASE_HREF\" class=\"code-anchor\">APP_BASE_HREF</a></code> in the browser version, so the <code>heroesUrl</code> remains relative.</p>\n<div class=\"l-sub-section\">\n<p translation-origin=\"off\">You can ignore <code><a href=\"api/common/APP_BASE_HREF\" class=\"code-anchor\">APP_BASE_HREF</a></code> in the browser if you've specified <code>&#x3C;base href=\"/\"></code> in the <code>index.html</code>\nto satisfy the router's need for a base address, as the tutorial sample does.</p>\n</div>\n<a id=\"server-code\"></a>\n<h2 translation-origin=\"off\" id=\"server-code\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#server-code\"><i class=\"material-icons\">link</i></a>Server code</h2>\n<p translation-origin=\"off\">To run an Angular Universal application, you'll need a server that accepts client requests and returns rendered pages.</p>\n<a id=\"app-server-module\"></a>\n<h3 translation-origin=\"off\" id=\"app-server-module\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#app-server-module\"><i class=\"material-icons\">link</i></a>App server module</h3>\n<p translation-origin=\"off\">The app server module class (conventionally named <code>AppServerModule</code>) is an Angular module that wraps the application's root module (<code>AppModule</code>) so that Universal can mediate between your application and the server.\n<code>AppServerModule</code> also tells Angular how to bootstrap your application when running as a Universal app.</p>\n<p translation-origin=\"off\">Create an <code>app.server.module.ts</code> file in the <code>src/app/</code> directory with the following <code>AppServerModule</code> code:</p>\n<code-example path=\"universal/src/app/app.server.module.ts\" title=\"src/app/app.server.module.ts\">\nimport { <a href=\"api/core/NgModule\" class=\"code-anchor\">NgModule</a> } from '@angular/core';\nimport { <a href=\"api/platform-server/ServerModule\" class=\"code-anchor\">ServerModule</a> } from '@angular/platform-server';\nimport { ModuleMapLoaderModule } from '@nguniversal/module-map-ngfactory-loader';\n\nimport { AppModule } from './app.module';\nimport { AppComponent } from './app.component';\n\n@<a href=\"api/core/NgModule\" class=\"code-anchor\">NgModule</a>({\n  imports: [\n    AppModule,\n    <a href=\"api/platform-server/ServerModule\" class=\"code-anchor\">ServerModule</a>,\n    ModuleMapLoaderModule\n  ],\n  providers: [\n    // Add universal-only providers here\n  ],\n  bootstrap: [ AppComponent ],\n})\nexport class AppServerModule {}\n\n\n</code-example>\n<p translation-origin=\"off\">Notice that it imports first the client app's <code>AppModule</code>, the Angular Universal's <code><a href=\"api/platform-server/ServerModule\" class=\"code-anchor\">ServerModule</a></code> and the <code>ModuleMapLoaderModule</code>.</p>\n<p translation-origin=\"off\">The <code>ModuleMapLoaderModule</code> is a server-side module that allows lazy-loading of routes.</p>\n<p translation-origin=\"off\">This is also the place to register providers that are specific to running your app under Universal.</p>\n<a id=\"web-server\"></a>\n<h3 translation-origin=\"off\" id=\"universal-web-server\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#universal-web-server\"><i class=\"material-icons\">link</i></a>Universal web server</h3>\n<p translation-origin=\"off\">A <em>Universal</em> web server responds to application <em>page</em> requests with static HTML rendered by the <a href=\"guide/universal#universal-engine\">Universal template engine</a>.</p>\n<p translation-origin=\"off\">It receives and responds to HTTP requests from clients (usually browsers).\nIt serves static assets such as scripts, css, and images.\nIt may respond to data requests, perhaps directly or as a proxy to a separate data server.</p>\n<p translation-origin=\"off\">The sample web server for <em>this</em> guide is based on the popular <a href=\"https://expressjs.com/\">Express</a> framework.</p>\n<div class=\"l-sub-section\">\n<p translation-origin=\"off\">  <em>Any</em> web server technology can serve a Universal app as long as it can call Universal's <code><a href=\"api/platform-server/renderModuleFactory\" class=\"code-anchor\">renderModuleFactory</a></code>.\nThe principles and decision points discussed below apply to any web server technology that you chose.</p>\n</div>\n<p translation-origin=\"off\">Create a <code>server.ts</code> file in the root directory and add the following code:</p>\n<code-example path=\"universal/server.ts\" title=\"server.ts\">\n// These are important and needed before anything else\nimport 'zone.js/dist/zone-node';\nimport 'reflect-metadata';\n\nimport { <a href=\"api/core/enableProdMode\" class=\"code-anchor\">enableProdMode</a> } from '@angular/core';\n\nimport * as express from 'express';\nimport { join } from 'path';\n\n// Faster server renders w/ Prod mode (dev mode never needed)\n<a href=\"api/core/enableProdMode\" class=\"code-anchor\">enableProdMode</a>();\n\n// Express server\nconst app = express();\n\nconst PORT = process.env.PORT || 4000;\nconst DIST_FOLDER = join(process.cwd(), 'dist');\n\n// * NOTE :: leave this as require() since this file is built Dynamically from webpack\nconst { AppServerModuleNgFactory, LAZY_MODULE_MAP } = require('./dist/server/main.bundle');\n\n// Express Engine\nimport { ngExpressEngine } from '@nguniversal/express-engine';\n// Import module map for lazy loading\nimport { provideModuleMap } from '@nguniversal/module-map-ngfactory-loader';\n\napp.engine('html', ngExpressEngine({\n  bootstrap: AppServerModuleNgFactory,\n  providers: [\n    provideModuleMap(LAZY_MODULE_MAP)\n  ]\n}));\n\napp.set('view engine', 'html');\napp.set('views', join(DIST_FOLDER, '<a href=\"api/animations/browser\" class=\"code-anchor\">browser</a>'));\n\n// TODO: implement data requests securely\napp.get('/api/*', (req, res) => {\n  res.status(404).send('data requests are not supported');\n});\n\n// Server <a href=\"api/upgrade/static\" class=\"code-anchor\">static</a> files from /<a href=\"api/animations/browser\" class=\"code-anchor\">browser</a>\napp.get('*.*', express.<a href=\"api/upgrade/static\" class=\"code-anchor\">static</a>(join(DIST_FOLDER, '<a href=\"api/animations/browser\" class=\"code-anchor\">browser</a>')));\n\n// All regular routes use the Universal engine\napp.get('*', (req, res) => {\n  res.render(join(DIST_FOLDER, '<a href=\"api/animations/browser\" class=\"code-anchor\">browser</a>', 'index.html'), { req });\n});\n\n// Start up the Node server\napp.listen(PORT, () => {\n  console.log(`Node server listening on http://localhost:${PORT}`);\n});\n\n\n</code-example>\n<div class=\"alert is-critical\">\n<p translation-origin=\"off\">  <strong>This sample server is not secure!</strong>\nBe sure to add middleware to authenticate and authorize users\njust as you would for a normal Angular application server.</p>\n</div>\n<a id=\"universal-engine\"></a>\n<h4 translation-origin=\"off\" id=\"universal-template-engine\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#universal-template-engine\"><i class=\"material-icons\">link</i></a>Universal template engine</h4>\n<p translation-origin=\"off\">The important bit in this file is the <code>ngExpressEngine</code> function:</p>\n<code-example path=\"universal/server.ts\" title=\"server.ts\" region=\"ngExpressEngine\">\napp.engine('html', ngExpressEngine({\n  bootstrap: AppServerModuleNgFactory,\n  providers: [\n    provideModuleMap(LAZY_MODULE_MAP)\n  ]\n}));\n\n</code-example>\n<p translation-origin=\"off\">The <code>ngExpressEngine</code> is a wrapper around the universal's <code><a href=\"api/platform-server/renderModuleFactory\" class=\"code-anchor\">renderModuleFactory</a></code> function that turns a client's requests into server-rendered HTML pages.\nYou'll call that function within a <em>template engine</em> that's appropriate for your server stack.</p>\n<p translation-origin=\"off\">The first parameter is the <code>AppServerModule</code> that you wrote <a href=\"guide/universal#app-server-module\">earlier</a>.\nIt's the bridge between the Universal server-side renderer and your application.</p>\n<p translation-origin=\"off\">The second parameter is the <code>extraProviders</code>. It is an optional Angular dependency injection providers, applicable when running on this server.</p>\n<a id=\"provide-origin\"></a>\n<p translation-origin=\"off\">You supply <code>extraProviders</code> when your app needs information that can only be determined by the currently running server instance.</p>\n<p translation-origin=\"off\">The required information in this case is the running server's origin, provided under the <code><a href=\"api/common/APP_BASE_HREF\" class=\"code-anchor\">APP_BASE_HREF</a></code> token, so that the app can <a href=\"guide/universal#http-urls\">calculate absolute HTTP URLs</a>.</p>\n<p translation-origin=\"off\">The <code>ngExpressEngine</code> function returns a <em>promise</em> that resolves to the rendered page.</p>\n<p translation-origin=\"off\">It's up to your engine to decide what to do with that page.\n<em>This engine's</em> promise callback returns the rendered page to the <a href=\"guide/universal#web-server\">web server</a>,\nwhich then forwards it to the client in the HTTP response.</p>\n<div class=\"l-sub-section\">\n<p translation-origin=\"off\">  This wrappers are very useful to hide the complexity of the <code><a href=\"api/platform-server/renderModuleFactory\" class=\"code-anchor\">renderModuleFactory</a></code>. There are more wrappers for different backend technologies\nat the <a href=\"https://github.com/angular/universal\">Universal repository</a>.</p>\n</div>\n<h4 translation-origin=\"off\" id=\"filter-request-urls\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#filter-request-urls\"><i class=\"material-icons\">link</i></a>Filter request URLs</h4>\n<p translation-origin=\"off\">The web server must distinguish <em>app page requests</em> from other kinds of requests.</p>\n<p translation-origin=\"off\">It's not as simple as intercepting a request to the root address <code>/</code>.\nThe browser could ask for one of the application routes such as <code>/dashboard</code>, <code>/heroes</code>, or <code>/detail:12</code>.\nIn fact, if the app were <em>only</em> rendered by the server, <em>every</em> app link clicked would arrive at the server\nas a navigation URL intended for the router.</p>\n<p translation-origin=\"off\">Fortunately, application routes have something in common: their URLs lack file extensions.</p>\n<p translation-origin=\"off\">Data requests also lack extensions but they're easy to recognize because they always begin with <code>/api</code>.</p>\n<p translation-origin=\"off\">All static asset requests have a file extension (e.g., <code>main.js</code> or <code>/node_modules/zone.js/dist/zone.js</code>).</p>\n<p translation-origin=\"off\">So we can easily recognize the three types of requests and handle them differently.</p>\n<ol>\n<li>\n<p translation-origin=\"off\">data request -  request URL that begins <code>/api</code></p>\n</li>\n<li>\n<p translation-origin=\"off\">app navigation - request URL with no file extension</p>\n</li>\n<li>\n<p translation-origin=\"off\">static asset - all other requests.</p>\n</li>\n</ol>\n<p translation-origin=\"off\">An Express server is a pipeline of middleware that filters and processes URL requests one after the other.</p>\n<p translation-origin=\"off\">You configure the Express server pipeline with calls to <code>app.get()</code> like this one for data requests.</p>\n<code-example path=\"universal/server.ts\" title=\"server.ts (data URL)\" region=\"data-request\" linenums=\"false\">\n// TODO: implement data requests securely\napp.get('/api/*', (req, res) => {\n  res.status(404).send('data requests are not supported');\n});\n\n</code-example>\n<div class=\"l-sub-section\">\n<p translation-origin=\"off\">This sample server doesn't handle data requests.</p>\n<p translation-origin=\"off\">The tutorial's \"in-memory web api\" module, a demo and development tool, intercepts all HTTP calls and\nsimulates the behavior of a remote data server.\nIn practice, you would remove that module and register your web api middleware on the server here.</p>\n</div>\n<div class=\"alert is-critical\">\n<p translation-origin=\"off\"><strong>Universal HTTP requests have different security requirements</strong></p>\n<p translation-origin=\"off\">HTTP requests issued from a browser app are not the same as when issued by the universal app on the server.</p>\n<p translation-origin=\"off\">When a browser makes an HTTP request, the server can make assumptions about cookies, XSRF headers, etc.</p>\n<p translation-origin=\"off\">For example, the browser automatically sends auth cookies for the current user.\nAngular Universal cannot forward these credentials to a separate data server.\nIf your server handles HTTP requests, you'll have to add your own security plumbing.</p>\n</div>\n<p translation-origin=\"off\">The following code filters for request URLs with no extensions and treats them as navigation requests.</p>\n<code-example path=\"universal/server.ts\" title=\"server.ts (navigation)\" region=\"navigation-request\" linenums=\"false\">\n// All regular routes use the Universal engine\napp.get('*', (req, res) => {\n  res.render(join(DIST_FOLDER, '<a href=\"api/animations/browser\" class=\"code-anchor\">browser</a>', 'index.html'), { req });\n});\n\n</code-example>\n<h4 translation-origin=\"off\" id=\"serve-static-files-safely\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#serve-static-files-safely\"><i class=\"material-icons\">link</i></a>Serve static files safely</h4>\n<p translation-origin=\"off\">A single <code>app.use()</code> treats all other URLs as requests for static assets\nsuch as JavaScript, image, and style files.</p>\n<p translation-origin=\"off\">To ensure that clients can only download the files that they are <em>permitted</em> to see, you will <a href=\"guide/universal#universal-webpack-configuration\">put all client-facing asset files in the <code>/dist</code> folder</a>\nand will only honor requests for files from the <code>/dist</code> folder.</p>\n<p translation-origin=\"off\">The following express code routes all remaining requests to <code>/dist</code>; it returns a <code>404 - NOT FOUND</code> if the file is not found.</p>\n<code-example path=\"universal/server.ts\" title=\"server.ts (static files)\" region=\"static\" linenums=\"false\">\n// Server <a href=\"api/upgrade/static\" class=\"code-anchor\">static</a> files from /<a href=\"api/animations/browser\" class=\"code-anchor\">browser</a>\napp.get('*.*', express.<a href=\"api/upgrade/static\" class=\"code-anchor\">static</a>(join(DIST_FOLDER, '<a href=\"api/animations/browser\" class=\"code-anchor\">browser</a>')));\n\n</code-example>\n<a id=\"universal-configuration\"></a>\n<h2 translation-origin=\"off\" id=\"configure-for-universal\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#configure-for-universal\"><i class=\"material-icons\">link</i></a>Configure for Universal</h2>\n<p translation-origin=\"off\">The server application requires its own build configuration.</p>\n<a id=\"universal-typescript-configuration\"></a>\n<h3 translation-origin=\"off\" id=\"universal-typescript-configuration\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#universal-typescript-configuration\"><i class=\"material-icons\">link</i></a>Universal TypeScript configuration</h3>\n<p translation-origin=\"off\">Create a <code>tsconfig.server.json</code> file in the project root directory to configure TypeScript and AOT compilation of the universal app.</p>\n<code-example path=\"universal/src/tsconfig.server.json\" title=\"src/tsconfig.server.json\">\n{\n  \"extends\": \"../tsconfig.json\",\n  \"compilerOptions\": {\n    \"outDir\": \"../out-tsc/app\",\n    \"baseUrl\": \"./\",\n    \"module\": \"commonjs\",\n    \"types\": []\n  },\n  \"exclude\": [\n    \"test.ts\",\n    \"**/*.spec.ts\"\n  ],\n  \"angularCompilerOptions\": {\n    \"entryModule\": \"app/app.server.module#AppServerModule\"\n  }\n}\n\n\n</code-example>\n<p translation-origin=\"off\">This config extends from the root's <code>tsconfig.json</code> file. Certain settings are noteworthy for their differences.</p>\n<ul>\n<li>\n<p translation-origin=\"off\">The <code>module</code> property must be <strong>commonjs</strong> which can be require()'d into our server application.</p>\n</li>\n<li>\n<p translation-origin=\"off\">The <code>angularCompilerOptions</code> section guides the AOT compiler:</p>\n<ul>\n<li><code>entryModule</code> - the root module of the server application, expressed as <code>path/to/file#ClassName</code>.</li>\n</ul>\n</li>\n</ul>\n<h3 translation-origin=\"off\" id=\"universal-webpack-configuration\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#universal-webpack-configuration\"><i class=\"material-icons\">link</i></a>Universal Webpack configuration</h3>\n<p translation-origin=\"off\">Universal applications doesn't need any extra Webpack configuration, the CLI takes care of that for you,\nbut since the server is a typescript application, you will use Webpack to transpile it.</p>\n<p translation-origin=\"off\">Create a <code>webpack.server.config.js</code> file in the project root directory with the following code.</p>\n<code-example path=\"universal/webpack.server.config.js\" title=\"webpack.server.config.js\">\nconst path = require('path');\nconst webpack = require('webpack');\n\nmodule.exports = {\n  entry: { server: './server.ts' },\n  resolve: { extensions: ['.js', '.ts'] },\n  target: 'node',\n  // this makes sure we include node_modules and other 3rd party libraries\n  externals: [/(node_modules|main\\..*\\.js)/],\n  output: {\n    path: path.join(__dirname, 'dist'),\n    filename: '[name].js'\n  },\n  module: {\n    rules: [{ test: /\\.ts$/, loader: 'ts-loader' }]\n  },\n  plugins: [\n    // Temporary Fix for issue: https://github.com/angular/angular/issues/11580\n    // for 'WARNING Critical dependency: the request of <a href=\"api/router/RouterLinkWithHref\" class=\"code-anchor\">a</a> dependency is an expression'\n    new webpack.ContextReplacementPlugin(\n      /(.+)?angular(\\\\|\\/)core(.+)?/,\n      path.join(__dirname, 'src'), // location of your src\n      {} // <a href=\"api/router/RouterLinkWithHref\" class=\"code-anchor\">a</a> map of your routes\n    ),\n    new webpack.ContextReplacementPlugin(\n      /(.+)?express(\\\\|\\/)(.+)?/,\n      path.join(__dirname, 'src'),\n      {}\n    )\n  ]\n};\n\n\n</code-example>\n<p translation-origin=\"off\"><strong>Webpack configuration</strong> is a rich topic beyond the scope of this guide.</p>\n<h2 translation-origin=\"off\" id=\"build-and-run-with-universal\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#build-and-run-with-universal\"><i class=\"material-icons\">link</i></a>Build and run with universal</h2>\n<p translation-origin=\"off\">Now that you've created the TypeScript and Webpack config files, you can build and run the Universal application.</p>\n<p translation-origin=\"off\">First add the <em>build</em> and <em>serve</em> commands to the <code>scripts</code> section of the <code>package.json</code>:</p>\n<code-example format=\".\" language=\"ts\">\n\n\"scripts\": {\n    ...\n    \"build:universal\": \"npm run build:client-and-server-bundles &#x26;&#x26; npm run webpack:server\",\n    \"serve:universal\": \"node dist/server.js\",\n    \"build:client-and-server-bundles\": \"ng build --prod &#x26;&#x26; ng build --prod --app 1 --output-hashing=false\",\n    \"webpack:server\": \"webpack --config webpack.server.config.js --progress --colors\"\n    ...\n}\n\n</code-example>\n<a id=\"build\"></a>\n<h4 translation-origin=\"off\" id=\"build\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#build\"><i class=\"material-icons\">link</i></a>Build</h4>\n<p translation-origin=\"off\">From the command prompt, type</p>\n<code-example format=\".\" language=\"bash\">\n\nnpm run build:universal\n\n</code-example>\n<p translation-origin=\"off\">The Angular CLI compiles and bundles the universal app into two different folders, <code><a href=\"api/animations/browser\" class=\"code-anchor\">browser</a></code> and <code>server</code>.\nWebpack transpiles the <code>server.ts</code> file into Javascript.</p>\n<a id=\"serve\"></a>\n<h4 translation-origin=\"off\" id=\"serve\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#serve\"><i class=\"material-icons\">link</i></a>Serve</h4>\n<p translation-origin=\"off\">After building the application, start the server.</p>\n<code-example format=\".\" language=\"bash\">\n\nnpm run serve:universal\n\n</code-example>\n<p translation-origin=\"off\">The console window should say</p>\n<code-example format=\".\" language=\"bash\">\n\nNode server listening on http://localhost:4000\n\n</code-example>\n<h2 translation-origin=\"off\" id=\"universal-in-action\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#universal-in-action\"><i class=\"material-icons\">link</i></a>Universal in action</h2>\n<p translation-origin=\"off\">Open a browser to <a href=\"http://localhost:4000/\">http://localhost:4000/</a>.\nYou should see the familiar Tour of Heroes dashboard page.</p>\n<p translation-origin=\"off\">Navigation via <code>routerLinks</code> works correctly.\nYou can go from the Dashboard to the Heroes page and back.\nYou can click on a hero on the Dashboard page to display its Details page.</p>\n<p translation-origin=\"off\">But clicks, mouse-moves, and keyboard entries are inert.</p>\n<ul>\n<li>\n<p translation-origin=\"off\">Clicking a hero on the Heroes page does nothing.</p>\n</li>\n<li>\n<p translation-origin=\"off\">You can't add or delete a hero.</p>\n</li>\n<li>\n<p translation-origin=\"off\">The search box on the Dashboard page is ignored.</p>\n</li>\n<li>\n<p translation-origin=\"off\">The <em>back</em> and <em>save</em> buttons on the Details page don't work.</p>\n</li>\n</ul>\n<p translation-origin=\"off\">User events other than <code><a href=\"api/router/RouterLink\" class=\"code-anchor\">routerLink</a></code> clicks aren't supported.\nThe user must wait for the full client app to arrive.</p>\n<p translation-origin=\"off\">It will never arrive until you compile the client app\nand move the output into the <code>dist/</code> folder,\na step you'll take in just a moment.</p>\n<h2 translation-origin=\"off\" id=\"throttling\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#throttling\"><i class=\"material-icons\">link</i></a>Throttling</h2>\n<p translation-origin=\"off\">The transition from the server-rendered app to the client app happens quickly on a development machine.\nYou can simulate a slower network to see the transition more clearly and\nbetter appreciate the launch-speed advantage of a universal app running on a low powered, poorly connected device.</p>\n<p translation-origin=\"off\">Open the Chrome Dev Tools and go to the Network tab.\nFind the <a href=\"https://developers.google.com/web/tools/chrome-devtools/network-performance/reference#throttling\">Network Throttling</a> dropdown on the far right of the menu bar.</p>\n<p translation-origin=\"off\">Try one of the \"3G\" speeds.\nThe server-rendered app still launches quickly but the full client app may take seconds to load.</p>\n<a id=\"summary\"></a>\n<h2 translation-origin=\"off\" id=\"summary\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#summary\"><i class=\"material-icons\">link</i></a>Summary</h2>\n<h2 translation-result=\"\" id=\"summary-9\"><a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/universal#summary-9\"><i class=\"material-icons\">link</i></a>小结</h2>\n<p translation-origin=\"off\">This guide showed you how to take an existing Angular application and make it into a Universal app that does server-side rendering.\nIt also explained some of the key reasons for doing so.</p>\n<ul>\n<li>\n<p translation-origin=\"off\">Facilitate web crawlers (SEO)</p>\n</li>\n<li>\n<p translation-origin=\"off\">Support low-bandwidth or low-power devices</p>\n</li>\n<li>\n<p translation-origin=\"off\">Fast first page load</p>\n</li>\n</ul>\n<p translation-origin=\"off\">Angular Universal can greatly improve the perceived startup performance of your app.\nThe slower the network, the more advantageous it becomes to have Universal display the first page to the user.</p>\n\n</div>\n<!-- links to this doc:\n-->\n<!-- links from this doc:\n - api/animations/browser\n - api/common/APP_BASE_HREF\n - api/common/Location\n - api/common/http/HttpClient\n - api/common/isPlatformBrowser\n - api/core/APP_ID\n - api/core/Inject\n - api/core/NgModule\n - api/core/Optional\n - api/core/PLATFORM_ID\n - api/core/enableProdMode\n - api/http/Http\n - api/platform-browser/BrowserModule\n - api/platform-server/ServerModule\n - api/platform-server/renderModuleFactory\n - api/router/RouterLink\n - api/router/RouterLinkWithHref\n - api/upgrade/static\n - generated/zips/toh-pt6/toh-pt6.zip\n - generated/zips/universal/universal.zip\n - guide/aot-compiler\n - guide/router\n - guide/router.html#router-link\n - guide/universal#absolute-http-urls\n - guide/universal#angular-universal-server-side-rendering\n - guide/universal#app-server-module\n - guide/universal#build\n - guide/universal#build-and-run-with-universal\n - guide/universal#configure-for-universal\n - guide/universal#facilitate-web-crawlers\n - guide/universal#filter-request-urls\n - guide/universal#how-it-works\n - guide/universal#http-urls\n - guide/universal#install-the-tools\n - guide/universal#modify-the-client-app\n - guide/universal#performance-on-mobile-and-low-performance-devices\n - guide/universal#preparation\n - guide/universal#serve\n - guide/universal#serve-static-files-safely\n - guide/universal#server-code\n - guide/universal#show-the-first-page-quickly\n - guide/universal#summary\n - guide/universal#summary-9\n - guide/universal#the-example\n - guide/universal#the-root-appmodule\n - guide/universal#throttling\n - guide/universal#transition\n - guide/universal#universal-engine\n - guide/universal#universal-in-action\n - guide/universal#universal-template-engine\n - guide/universal#universal-typescript-configuration\n - guide/universal#universal-web-server\n - guide/universal#universal-webpack-configuration\n - guide/universal#web-server\n - guide/universal#why-universal\n - guide/universal#working-around-the-browser-apis\n - http://localhost:4000/\n - https://developers.google.com/web/tools/chrome-devtools/network-performance/reference#throttling\n - https://expressjs.com/\n - https://github.com/angular/universal\n - https://static.googleusercontent.com/media/www.google.com/en//webmasters/docs/search-engine-optimization-starter-guide.pdf\n - https://www.doubleclickbygoogle.com/articles/mobile-speed-matters/\n-->"
}